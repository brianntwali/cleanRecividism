---
title: "Main Analysis"
output:
  html_document:
    df_print: paged
---

Load libraries
```{r}
library(stargazer)
library(haven)
library(dplyr)
library(lfe)
library(ggplot2)
library(htmltools)

library(broom)
library(lubridate)
library(fixest)
```



Define filepaths
```{r}
# encrypted drive path
# Brian
encripted_drive_path <- "/Volumes/Untitled/"


# Neil mac
encripted_drive_path <- "/Users/silveus/Documents/Data/PA DOC/" 
# Neil PC 
#encripted_drive_path <- "" 

# analysis path

analysis_datapath <- paste0(encripted_drive_path,"intermediate data/")


```

```{r}

# Loading Calendar Data

daily_individual_reg_data_quarter <- readRDS("daily_data_per_quarter.RDS")

daily_individual_reg_data_month <- readRDS("daily_data_per_month.RDS")

View(daily_individual_reg_data_quarter)



# Loading Arrival data 

quarter_indiv_arrival_reg_data <-read.csv(paste0(analysis_datapath,"individual_per_quarter.csv"),
                                   colClasses = c("control_number" = "character"))
quarter_indiv_arrival_reg_data <- quarter_indiv_arrival_reg_data[, -1] %>% 
  mutate(period_group = ymd(period_group)) %>% 
  ungroup()

monthly_indiv_arrival_data <-read.csv(paste0(analysis_datapath,"individual_per_quarter.csv"),
                                   colClasses = c("control_number" = "character"))
monthly_indiv_arrival_data <- monthly_indiv_arrival_data[, -1] %>% 
  mutate(period_group = ymd(period_group)) %>% 
  ungroup()

# individual_daily_data <- readRDS(paste0(analysis_datapath,"Main files/main_complete_df.rds"))
# individual_daily_data <- individual_daily_data %>% 
#   relocate(c(ID, loc), .before = 1) %>% 
#   # spelling error 
#   filter(facility_type != "UNKOWN")
# 
# View(individual_daily_data)


```


# Updating variable and dataframe names is needed

<!-- How do arrivals to CCFs compare to arrivals to CCCs prior to 2013? The below requires a dataset for analysis that has a dummy variable for post (>= 2013) and a dummy variable for ccf(1 if ccf, 0 if ccc). The dataset should be individual arrivals. -->
<!-- ```{r} -->
<!-- balancereg1 <- felm(avg_lsir~ccf,reg_data[reg_data$post==0]) -->
<!-- balancereg2 <- felm(count_black~ccf,reg_data[reg_data$post==0]) -->
<!-- balancereg3 <- felm(avg_age~ccf,reg_data[reg_data$post==0]) -->
<!-- balancereg4 <- felm(drug_offenses~ccf,reg_data[reg_data$post==0]) -->
<!-- balancereg5 <- felm(violent_offenses~ccf, reg_data[reg_data$post==0]) -->
<!-- balancereg6 <- felm(count <- ccf, reg_data[reg_data$post==0] %>%  -->
<!--                                                 group_by(loc,month) %>%  -->
<!--                                                 summarise(arrivals=n()), -->
<!--                                                           ccf=first(ccf), -->
<!--                                                           post=first(post)) -->


<!-- htmloutput <- stargazer(balangereg1,balangereg2,balangereg3,balangereg4,balangereg5,balancereg6, type = "html") -->

<!-- html_print(HTML(htmloutput)) -->
<!-- ``` -->

<!-- ## Baseline DID -->

<!-- ### Risk Scores -->
<!-- ```{r} -->
<!-- reg1 <- felm(avelsir ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(avelsir ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->

<!-- htmloutput <- stargazer(reg1,reg2, type = "html") -->

<!-- html_print(HTML(htmloutput)) -->
<!-- ``` -->

<!-- ### Race -->
<!-- ```{r} -->
<!-- reg1 <- felm(blackarrivals ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(blackarrivals ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->

<!-- htmloutput <- stargazer(reg1,reg2, type = "html") -->

<!-- html_print(HTML(htmloutput)) -->
<!-- ``` -->

<!-- ### Offence Types -->
<!-- ```{r} -->
<!-- # Violent -->
<!-- reg1 <- felm(arrivals_violent ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(arrivals_violent ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->

<!-- # Drug -->
<!-- reg1 <- felm(arrivals_drug ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(arrivals_drug ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->

<!-- # Property -->
<!-- reg1 <- felm(arrivals_property ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(arrivals_property ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- htmloutput <- stargazer(reg1,reg2, type = "html") -->

<!-- # Public Order -->
<!-- reg1 <- felm(arrivals_public ~ ccf + post + ccf*post year region avenumberarrivals2008_2010 avelsir2008_2010 avepctblack2008_2010 |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- reg2 <- felm(arrivals_public ~ ccf + post + ccf*post |loc + year + calandermonth|0|0, data=reg_data) -->
<!-- htmloutput <- stargazer(reg1,reg2,reg3, reg4, reg5, reg6, reg7, reg8, type = "html") -->


<!-- html_print(HTML(htmloutput)) -->
<!-- ``` -->



## Baseline Event Studies

The basic event study for facility level analyses will take the following form:

$$
y_{ft}=\alpha+CCF_f\times\sum^{14}_{\substack{\tau=-14}\\ \tau\neq -1}\beta_{\tau}I(t-t^*=\tau)+\gamma_f +\lambda_t+\epsilon_{ft}
$$
Where: 

* $\alpha$: Constant
* $CCF$: Dummy variable equal to 1 if facility if CCF
* $I(t-t^*=\tau)$: $t^*$ is the time period of treatment. $I(t-t^*=\tau)$ is an indicator function that is equal to one if $t$ is $\tau$ periods from treatment
* $gamma_f$ and $lambda_t$ are facility and period fixed effects respectively


### Create a function to create an event study graph using the specification above
```{r}
make_es <- function(pre_period_num,post_period_num,outcome_variable, treatment_date, data, confidence_interval=0.95, graph_label="Enter graph label"){

trt_year <- as.numeric(substr(treatment_date, 5, 8))
trt_month <- as.numeric(substr(treatment_date,1,2))
trt_quarter <- ceiling(4*(trt_month/12))


es_data <- data %>% arrange(year, quarter) %>% group_by(year, quarter) %>% mutate(period_index=cur_group_id()) %>% ungroup()

es_data <- es_data %>% mutate(post=ifelse(year>trt_year|(year==trt_year & quarter>=trt_quarter),1,0))

#get index number for the treatment period. The result is an integer.
trt_index <- es_data %>% filter(year==trt_year, quarter==trt_quarter) %>% distinct(year,quarter,.keep_all = TRUE) %>% pull("period_index")

#recenter the periods so that the treatment period is indexed as zero
es_data <- es_data %>% mutate(period_index=period_index-trt_index)

#keep only observations within the specified event window
es_data <- es_data %>% filter(period_index<=post_period_num & period_index >= -1*(pre_period_num))

# Convert 'period_index' to factor and set reference level to "-1"
es_data$period_factor <- relevel(factor(es_data$period_index), ref = "-1")
# Make facility_type_CCF a factor
es_data$facility_type_CCF <- factor(es_data$facility_type_CCF)

# Ensure 'outcome_variable' exists in the data
if (!outcome_variable %in% names(es_data)) {
  stop(paste("The outcome variable", outcome_variable, "is not found in the dataset"))
}

# Fit the fixed effects model

formula <- as.formula(paste(outcome_variable, "~ period_factor + facility_type_CCF*period_factor"))
es_reg <- feols(formula, es_data)

coefficients <- coeftable(summary(es_reg, n = 103))

# Convert coefficients to data frame
coef_df <- data.frame(
  term = rownames(coefficients),
  estimate = coefficients[, "Estimate"],
  std.error = coefficients[, "Std. Error"]
)


# Keep event study coefficients
coef_df <- coef_df %>%
    filter(grepl("CCF", term) & grepl("period_factor", term))


#Manually add omitted coefficient
ref_coeff <- data.frame(
    term = "period_factor-1:facility_type_CCF1",
    estimate = 0,
    std.error = 0
)

coef_df <- rbind(coef_df, ref_coeff)


# Add confidence intervals
zscore=qnorm((1-confidence_interval)/2+confidence_interval)
coef_df <- coef_df %>%
  mutate(
    conf.low = estimate - zscore * std.error,
    conf.high = estimate + zscore * std.error
  )

# Specify the desired order for the period factors
desired_order <- paste0("period_factor", -pre_period_num:post_period_num,":facility_type_CCF1")
coef_df <- coef_df %>%
  mutate(term = factor(term, levels = desired_order)) %>%
  arrange(term)


# Plot the coefficients
ggplot(coef_df, aes(x = term, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete(
    breaks = desired_order[seq(1, length(desired_order), by = 2)],  # Set breaks for every other tick
    labels = as.character(seq(-pre_period_num, post_period_num, by = 2))  # Customize labels
  ) +
  labs(title = graph_label,
       x = "Event Time (quarters)",
       y = "")
}

#number of pre periods
pre_period_num=14
#number of post periods
post_period_num=14
#outcome variable
outcome_variable <- 'avg_lsir'
#define treatment date MMDDYYY
treatment_date <- "07012013"

```


### Average LSIR event study
```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'avg_lsir', treatment_date = '01012013', data = indiv_arrival_reg_data, confidence_interval = 0.95, graph_label = "Average LSIR of Arrivals")

make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'avg_lsir', treatment_date = '01012013', data = daily_individual_reg_data_quarter, confidence_interval = 0.95, graph_label = "Average LSIR of Calendar")
```

### Average age event study

```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'avg_age', treatment_date = '07012013', data = arrival_FAKE_reg_data_facility, confidence_interval = 0.95, graph_label = "Average Age of Arrivals")
```

### Number of black arrivals event study
```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'count_black', treatment_date = '07012013', data = arrival_FAKE_reg_data_facility, confidence_interval = 0.95, graph_label = "# of Black arrivals")
```



### Number of drug offense arrivals event study
```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'drug_offenses', treatment_date = '07012013', data = arrival_FAKE_reg_data_facility, confidence_interval = 0.95, graph_label = "# Drug offense arrivals")
```


### Number of violent offense arrivals event study
```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'arrivals_violent', treatment_date = '07012013', data = arrival_FAKE_reg_data_facility, confidence_interval = 0.95, graph_label = "# Violent offense arrivals")
```

### Number of property offense arrivals event study
```{r}
make_es(pre_period_num = 14, post_period_num = 14, outcome_variable = 'property_offenses', treatment_date = '07012013', data = arrival_FAKE_reg_data_facility, confidence_interval = 0.95, graph_label = "# Property offense arrivals")
```
```


# Manually add each period's dummy variable (what it looks like with all its coeff)



# Think about unemployment + other economic conditions for 
# recidivism outcome
>>>>>>> 96f944d (Changes to various files. Updated regression in Analysis Notebook to account for collinearity.)

